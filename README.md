# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка продукта

```
export interface IProduct {
  id: string;
  description: string;
  image: string;
  title: string;
  category: string;
  price: number | null;
}
```

Список карточек продуктов (каталог)

```
export interface IProductList {
  total: number | null;
  items: IProduct[];
}
```

Корзина

```
export interface IOrder {
  payment: string;
  email: string;
  phone: string;
  address: string;
  total: number;
  items: string[];
}
```

Сформированный заказ

```
export interface IOrderResult {
  id: string;
  total: number | null;
}
```

## Переиспользование типов для отображения компонентов

Форма со способом оплаты и адресом

```
export type TAddressForm = Pick<IOrder, 'payment' | 'address'>
```

Форма с почтой и номером телефона

```
export type TContactsForm = Pick<IOrder, 'email'| 'phone'>
```

Полная информация о покупателе

```
export type TBuyerInfo = TAddressForm & TContactsForm;
```

Типы ошибок в формах

```
export type TFormErrors = Partial<Record<keyof IOrder, string>>;
```

## Интерфейсы моделей данных

Данные о покупателе

```
export interface IBuyerData {
	setBuyerInfo(buyerData: IOrder): void;
	validateAddressForm(): boolean;
	validateContactsForm(): boolean;
}
```

Общие данные состояния приложения

```
export interface IAppState {
	catalog: ICard[];
	basket: string[];
	preview: string | null;
	order: IOrder | null;
	loading: boolean;
}
```

Состояние формы

```
export interface IFormState {
	valid: boolean;
	errors: string[];
}
```

Данные модального окна

```
export interface IModalData {
	content: HTMLElement;
}
```

## Типизация действий

Карточки

```
export interface ICardActions {
	onClick: (event: MouseEvent) => void;
}
```

Модального окна успеха

```
export interface ISuccess {
	total: number;
}
```
## Компоненты

Модальное окно успеха

```
export interface ISuccess {
	total: number;
}
```

Карточка товара

```
export interface ICard {
	title: string;
	description?: string;
	image?: string;
	category?: string;
	price: number | null;
}
```

Главная страница

```
export interface IPage {
	counter: number;
	basketButton: HTMLButtonElement;
	catalog: HTMLElement[];
	locked: boolean;
}
```

Корзина

```
export interface IBasketView {
	items: HTMLElement[];
	total: number;
	selected: string[];
}
```

## API

```
export interface IApi {
	baseUrl: string;
	get<T>(url: string): Promise<T>;
	post<T>(url: string, data: object, method?: ApiPostMethods): Promise<T>;
}
```

## Архитектура приложения

Код приложения разделён на слои согласно парадигме MVP:

- слой представления, отвечает за отображение данных на странице;
- слой данных, отвечает за хранение и изменение данных;
- презентер, отвечает за связь представления и данных.

## Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В полях класса содержатся следующие данные:

- `readonly baseUrl: string;` - базовый url;
- `protected options: RequestInit;` - объект с настройками.

Конструктор класса:

`constructor(baseUrl: string, options: RequestInit = {})`- принимает базовый URL и глобальные опции для всех запросов(опционально).

В классе реализованы следующие методы:

- `protected handleResponse(response: Response): Promise<object>` - метод обрабатывает ответ сервера и возвращает ответ в формате json или возвращает промис с указанием причины отказа;
- `get(uri: string)` - выполняет GET-запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер;
- `post(uri: string, data: object, method: ApiPostMethods = 'POST)` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправлет эти данные на ендпоинт, переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть определён заданием третьего параметра при вызове (методы хранятся в типе `ApiPostMethods`).

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.
Основные методы, реализуемые классом, описаны интерфейсом `IEvents`:

- `on` - подписка на событие: принимает событие и выполняемый колбэк;
- `emit` - инициализация события: принимает событие и опционально дополнительные данные;
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие: принимает событие и контекст (опционально)

Класс `EventEmitter` - классическая реализация брокера событий, имплементирует интерфейс `IEvents` и имеет поле `_events`, в котором хранятся данные в формате "ключ-значение", где ключ - название события, а значение - объект с подписчиками на событие.

В конструкторе формируется объект событий:
`constructor() {this._events = new Map<EventName, Set<Subscriber>>();}`.

Класс реализует следующие методы:

- `on<T extends object>(eventName: EventName, callback: (event: T) => void)` - устанавливает обработчик на событие, принимая название события и колбэк;
- `off(eventName: EventName, callback: Subscriber)` - аналогично снимает обработчик с события;
- `emit<T extends object>(eventName: string, data?: T)` - инициирует событие с данными, принимая на вход название события и данные (опционально);
- `onAll(callback: (event: EmitterEvent) => void)` и `offAll()` - позволяют слушать все события и назначить обработчики либо снять все обработчики;
- `trigger<T extends object>(eventName: string, context?: Partial<T>)` - метод принимает название события и опционально контекст и создаёт колбэк-триггер, генерирующий событие при вызове.

#### Класс Model

Абстрактный класс описывает базовую модель, чтобы её можно было отличить от простых объектов с данными.
В конструктор класса передаются объект с данными и события:

```
constructor(data: Partial<T>, protected events: IEvents) {
        Object.assign(this, data);
    }
```

Класс реализует метод `emitChanges(event: string, payload?: object)`, сообщающий об изменении модели. Принимает событие и опционально объект payload, который может быть использован для добавления функциональности.

### Слой данных

#### Класс AppState

Класс отвечает за хранение данных и логику работы приложения. Расширяет класс Model. Содержит следующие поля:

- `basket: string[];` - содержимое корзины;
- `catalog: IProduct[];` - содержимое каталога товаров;
- ```order: IOrder = {
		payment: '',
		email: '',
		phone: '',
		address: '',
		total: null,
		items: [],
	};``` - содержимое заказа, включая данные покупателя;
- `preview: string | null;` - id товара, выбранного для превью в модальном окне;
- `formErrors: TFormErrors = {};` - ошибки форм.

Класс реализует следующие методы:

- `toggleOrderedProduct(id: string, isIncluded: boolean)` - в зависимости от наличия товара в корзине метод либо добавляет его, либо обновляет корзину с набором товаров без повтора;
- `addToBasket(id: string)` - метод добавляет продукт в корзину, принимая его id;
- `removeFromBasket(id: string)` - метод убирает продукт из корзины, принимая его id;
- `getProduct(productId: string)` - метод находит продукт в каталоге, принимая его id;
- `clearBasket()` - метод очищает корзину;
- `getBasketTotal()` - метод возвращает сумму покупки из корзины;
- `setCatalog(items: ICard[])` - метод устанавливает каталог товаров и генерирует событие изменения товаров;
- `setPreview(item: CardItem)` - метод отправляет карточку в превью и генерирует событие изменения превью;
- `setOrderField(field: keyof TBuyerInfo, value: string)` - метод устанавливает содержимое полей формы заказа и генерирует события готовности формы;
- `validateOrder()` - общий метод валидации заказа;
- `validateAddressForm(): boolean` - метод валидации формы с адресом;
- `validateContactsForm(): boolean` - метод валидации формы с почтой;

Конструктор метода наследуется от Model.

#### Класс CardItem

Класс расширяет Model, наследует его методы и конструктор и содержит следующие поля:

- `description: string;` - описание товара;
- `id: string;` - идентификатор товара;
- `image: string;` - изображение;
- `title: string;` - название;
- `category: string;` - категория;
- `price: number;` - цена.

### Слой представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемента) передаваемых в них данных.

#### Класс Component

Абстрактный класс, дженерик и родитель всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод `render` для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод `render`, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновлённый контейнер компонента. 

`protected constructor(protected readonly container: HTMLElement) {}` - в конструктор передаётся элемент контейнера.

Методы:

- `toggleClass(element: HTMLElement, className: string, force?: boolean)` - метод принимает сам элемент, название класса и булево значение, определяющее, как будет работать `classList.toggle()` (опционально) - и переключает класс у элемента;
- `protected setText(element: HTMLElement, value: unknown)` - метод принимает элемент и значение, которое задаёт ему в текстовое содержимое;
- `setDisabled(element: HTMLElement, state: boolean)` - метод принимает элемент и булево значение состояния, меняя статус блокировки;
- `protected setHidden(element: HTMLElement)` - метод принимает на вход элемент и скрывает его;
- `protected setVisible(element: HTMLElement)` - метод принимает элемент и делает его видимым, убирая свойство `display`;
- `protected setImage(element: HTMLImageElement, src: string, alt?: string)` - метод принимает элемент изображения, ссылку и альтернативный текст (опционально) и задаёт изображению атрибуты `src` и `alt`;
- `render(data?: Partial<T>): HTMLElement` - метод опционально принимает объект с данными и возвращает корневой DOM-элемент.

#### Класс Modal

Класс расширяет Component и реализует модальное окно. Предоставляет методы `open` и `close`, позволяющие управлять отображением модального окна. Устанавливает слушатели на клавиатуру для закрытия модального окна по Esc, на клик по оверлею и кнопку-крестик для закрытия попапа. \
Поля класса:

- `protected _closeButton: HTMLButtonElement;` - кнопка закрытия модалки;
- `protected _content: HTMLElement;` - содержимое модалки.

- `constructor(container: HTMLElement, protected events: IEvents)` - конструктор принимает HTML-элемент контейнера и экземпляр эмиттера `EventEmitter` для инициации событий.

Помимо методов открытия и закрытия попапа класс реализует методы:

- `set content(content: HTMLElement)` - сеттер для отображения содержимого модального окна;
- `handleEscUp(evt: KeyboardEvent)` - обрабатывает клик по кнопке Escape и закрывает модалку;
- `render(data: IModalData): HTMLElement` - метод расширяет функционал родительского: возвращает отрендеренный контейнер и открывает модальное окно.

#### Класс Basket

Класс расширяет Component и рендерит корзину. Поля класса:

- `protected _list: HTMLElement;` - элемент списка товаров в корзине;
- `protected _total: HTMLElement;` - элемент с финальной стоимостью;
- `protected _button: HTMLElement;` - кнопка оформления заказа.

Конструктор принимает контейнер и брокер событий и назначает HTML-элементы полям:
`constructor(container: HTMLElement, protected events: EventEmitter)`

Класс содержит сеттеры `set items(items: HTMLElement[])` и `set total(value: number)` для установки списка товаров и финальной стоимости.

#### Класс Form

Расширяет класс Component и отвечает за реализацию форм. Поля класса:

- `protected _submit: HTMLButtonElement;` - кнопка отправки формы;
- `protected _errors: HTMLElement;` - span-элемент для отображения ошибок.

В конструктор приходят контейнер и экземпляр эмиттера.

Класс реализует сеттеры:

- `set valid(value: boolean)` - сеттер дизейблит кнопку для невалидной формы;
- `set errors(value: string)` - сеттер устанавливает текст ошибки, используя родительский метод.

И метод:

- `protected onInputChange(field: keyof T, value: string) ` - метод генерирует событие изменения в поле формы.

Метод render, наследуемый от родительского класса, также задаёт ошибки формы.

Класс расширяется двумя классами для рендера формы с адресом и формы с почтой:

#### Класс AddressForm

Поля класса:

- `protected _payment: string | null;` - способ оплаты;
- `protected _cashButton?: HTMLButtonElement;` - кнопка оплаты наличными;
- `protected _cardButton?: HTMLButtonElement;` - кнопка оплаты онлайн;
- `protected _button: HTMLButtonElement;` - кнопка "далее";
- `protected _address?: HTMLInputElement;` - инпут с адресом.

В конструкторе, принимающем контейнер и экземпляр эмиттера, вызывается родительский метод onInputChange при нажатии каждой из кнопок оплаты и устанавливается слушатель на кнопку "далее".

Сеттеры оплаты и адреса устанавливают переданные им значения в соответствующие поля.

#### Класс ContactsForm

Поля класса:

- `	protected _button: HTMLButtonElement;` - кнопка отправки формы.

В конструкторе, принимающем контейнер и экземпляр эмиттера, на кнопку отправки формы навешивается слушатель, по которому генерируется событие отправки заказа.

Сеттеры телефона и почты устанавливают переданные им значения в соответствующие поля.

#### Класс Card

Расширяет класс Сomponent. Отвечает за отображение карточки, задавая в карточке данные названия, категории, изображения, описания и стоимости товара. Класс используется для отображения карточек на странице сайта.
В полях класса хранятся HTML элементы названия, изображения, идентификатора, категории, цены, описания карточки и кнопки, а также события.
 В конструктор класса передаётся название блока, контейнер, который заполняется передаваемыми в класс данными, события и опционально действия при нажатии на кнопку или карточку.

Класс реализует сеттеры и геттеры для полей, сеттер category помимо этого также навешивает классы для смены цвета категории, используя родительский метод toggleClass. 

Класс является универсальным для отображения карточки в каталоге, в превью и в корзине, поскольку часть полей в классе опциональны (изображение, категория, описание и кнопка).

#### Класс Page

Расширяет класс Component. Отвечает за отображение главной страницы сайта.
В полях класса содержатся ссылки на все элементы разметки блока:

- `counter: HTMLElement` - элемент счётчика корзины;
- `basketButton: HTMLButtonElement` - элемент кнопки корзины;
- `protected _catalog: HTMLElement` - каталог с товарами;
- `protected _wrapper: HTMLElement` - обёртка.

  Класс принимает в конструктор элемент разметки страницы и экземпляр `EventEmitter` для инициации событий при нажатии пользователем на кнопки. Устанавливает в конструкторе слушатели на все кнопки, при срабатывании которых генерируются соответствующие события.
  Методы:
- `set counter(value: number)` - сеттер устанавливает передаваемое значение в счётчик корзины;
- `set catalog(items: HTMLElement[])` - сеттер монтирует переданные элементы товаров в разметку контейнера;
- `set locked(value: boolean) ` - сеттер фиксирует обёртку при открытии модального окна.

#### Класс Success

Класс расширяет Component и отвечает за реализацию окна успешного оформления заказа. Поля:

- `protected _close: HTMLElement;` - кнопка закрытия окна;
- `protected _total: HTMLElement;` - элемент, отображающий общую сумму списанных синапсов.

`	constructor(container: HTMLElement, actions: ISuccessActions)` - конструктор принимает контейнер и объект с действиями, реализуемыми при нажатии кнопок, и устанавливает в поля close и total соответствующие элементы разметки. 

Сеттер total устанавливает текст с количеством списанных синапсов, принимая числовое значение.

### Слой коммуникации

#### Класс AppApi

Принимает в конструктор экземпляр класса Api и предоставляет методы, реализующие взаимодействие с бэкендом сервиса.

- `getProduct(id: string): Promise<IProduct>` - метод реализует GET-запрос и возвращает с сервера один продукт, получая его идентификатор;
- `getProducts(): Promise<IProduct[]>` - метод реализует GET-запрос и возвращает с сервера список продуктов;
- `setBuyer(data: IOrder): Promise<IOrder>` - метод реализует POST-запрос, отправляя переданные ему данные о покупке.

## Взаимодействие компонентов

Код, описывающий взаимодействие предоставления и данных между собой, находится в файле `index.ts`, выполняющем роль презентера. \
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

_Список всех событий, которые могут генерироваться в системе:_\
_События изменения данных (генерируются классами моделями данных)_

- `initialData:loaded` - окончание загрузки изначального списка продуктов;
- `preview:changed` - изменение открываемой в превью карточки;
- `basket:changed` - изменение наполнения корзины;
- `buyer:changed` - изменение данных о покупателе при оформлении заказа.

_События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)_

- `card:select` - выбор карточки для отображения в превью;
- `modal:open` - открытие модального окна;
- `modal:close` - закрытие модального окна;
- `basket:open` - открытие модального окна корзины;
- `order:open` - открытие модального окна с формой адреса;
- `contacts:open` - открытие модального окна с формами контактов покупателя;
- `success:open` - открытие модального окна уведомления об успешном оформлении заказа
- `card:select` - выбор карточки для отображения в модальном окне
- `basket:change` - добавление и удаление товара в корзине
- `payment:select` - выбор способа оплаты при оформлении
- `address:input` - изменение данных в форме адреса
- `email:input` - изменение данных в форме почты
- `phone:input` - изменение данных в форме номера телефона
- `addressErrors:change` - изменение данных об ошибках валидации формы с адресом;
- `contactsErrors:change` - изменение данных об ошибках валидации формы с почтой.
